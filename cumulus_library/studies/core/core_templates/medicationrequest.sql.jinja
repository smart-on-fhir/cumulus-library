{% import 'core_utils.jinja' as utils %}

CREATE TABLE core__medicationrequest AS
WITH temp_mr AS (
    SELECT 
        {{- utils.basic_cols(
                'medicationrequest',
                'mr',
                [
                    'id', 
                    'status', 
                    'intent',
                ]
            ) 
        }},
        {{- utils.date_cols_from_str(
                'medicationrequest',
                'mr',
                ['authoredOn'],
                schema
            ) 
        }},
        {{- utils.truncate_date_cols(
                'medicationrequest',
                'mr',
                [
                    ('authoredOn', 'month'),
                ],
                schema
            ) 
        }},
        {{- utils.nullable_cols(
                'medicationrequest',

                'mr',
                [
                    'display',
                    'reportedBoolean',
                    'dosageInstruction',
                    ('subject', 'reference', 'subject_ref'),
                    ('encounter', 'reference', 'encounter_ref'),
                ],
                schema
        ) -}},
        mrc.code AS category_code,
        mrc.code_system AS category_code_system,
        mrm.code AS medication_code,
        mrm.code_system AS medication_code_system,
        mrm.display AS medication_display
    FROM medicationrequest AS mr
    LEFT JOIN core__medicationrequest_dn_category AS mrc ON mr.id = mrc.id
    LEFT JOIN core__medicationrequest_dn_medication AS mrm ON mr.id = mrm.id
    WHERE mrm.code_system = 'http://www.nlm.nih.gov/research/umls/rxnorm'
)

SELECT
    mr.id,
    mr.status,
    mr.intent,
    mr.category_code,
    mr.category_code_system,
    mr.reportedBoolean,
    mr.medication_code_system,
    mr.medication_code,
    mr.medication_display,
    mr.authoredOn,
    mr.authoredOn_month,
    dose_row.dose_col.text AS dosageInstruction_text,
    mr.subject_ref,
    mr.encounter_ref
FROM temp_mr AS mr,
    UNNEST(dosageInstruction) AS dose_row (dose_col)
