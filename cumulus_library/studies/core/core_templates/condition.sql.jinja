{% import 'core_utils.jinja' as utils %}

CREATE TABLE core__condition AS
WITH temp_condition AS (
    SELECT
         {{- 
            utils.basic_cols(
                'condition',
                'c',
                [
                    'id',
                ]
            ) 
        }},
        {{- 
            utils.nullable_cols(
                'condition',
                'c',
                [
                    'category',
                    'verificationStatus',
                    'clinicalStatus',
                    ('subject', 'reference', 'subject_ref'),
                    ('encounter', 'reference', 'encounter_ref')
                ], 
                schema
            ) 
        }},
        {{- 
            utils.basic_cols(
                'core__condition_codable_concepts_all',
                'cca',
                [
                    'code',
                    'code_system',
                    'display'
                ]
            ) 
        }},
        {{- 
            utils.date_cols_from_str(
                'condition',
                'c',
                ['recordeddate'],
                schema
            ) 
        }},
        {{- 
            utils.truncate_date_cols(
                'condition',
                'c',
                [
                    ('recordeddate', 'week'),
                    ('recordeddate', 'month'),
                    ('recordeddate', 'year'),
                ],
                schema
            ) 
        }}
    FROM condition AS c
    LEFT JOIN core__condition_codable_concepts_all AS cca ON c.id = cca.id
)

SELECT
    tc.id,
    t_category_coding.category_row.code AS category_code,
    t_category_coding.category_row.display AS category_display,
    tc.code,
    tc.code_system,
    tc.display AS code_display,
    tc.subject_ref,
    tc.encounter_ref,
    concat('Condition/', tc.id) AS condition_ref,
    tc.recordeddate,
    tc.recordeddate_week AS recorded_week,
    tc.recordeddate_month AS recorded_month,
    tc.recordeddate_year AS recorded_year
FROM temp_condition AS tc,
    unnest(category) AS t_category (category_coding),
    unnest(category_coding.coding) AS t_category_coding (category_row)

WHERE tc.recordeddate BETWEEN date('2016-01-01') AND current_date;
